@model IEnumerable<FleetManagement.Application.Aircrafts.DTOs.AircraftDto>


@{
    Layout = "_AircraftsLayout";

    ViewData["Title"] = "Aircraft Fleet";
}

<style>
    .aircraft-container {
        padding: 1.5rem;
        background: var(--bg);
        min-height: 100vh;
    }

    .aircraft-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
    }

    .aircraft-header h1 {
        color: var(--text);
        font-size: 1.75rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: var(--transition);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.875rem;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(6, 60, 55, 0.2);
    }

    .btn-edit {
        background: #0ea5e9;
        color: white;
        padding: 0.375rem 0.75rem;
        font-size: 0.8125rem;
    }

    .btn-edit:hover {
        background: #0284c7;
    }

    .btn-delete {
        background: #ef4444;
        color: white;
        padding: 0.375rem 0.75rem;
        font-size: 0.8125rem;
    }

    .btn-delete:hover {
        background: #dc2626;
    }

    .btn-details {
        background: transparent;
        color: var(--primary);
        padding: 0.375rem 0.75rem;
        font-size: 0.8125rem;
        border: 1px solid var(--border);
    }

    .btn-details:hover {
        background: var(--surface-alt);
        border-color: var(--primary);
    }

    .aircraft-grid {
        display: grid;
        gap: 1rem;
    }

    .aircraft-card {
        background: var(--surface);
        border-radius: 10px;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        transition: var(--transition);
    }

    .aircraft-card:hover {
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.12);
    }

    #modalContent {
        width: 38% !important;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border);
    }

    .card-title {
        display: flex;
        align-items: center;
        gap: 0.625rem;
    }

    .registration {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text);
        margin: 0;
    }

    .status-badge {
        padding: 0.25rem 0.625rem;
        border-radius: 5px;
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .status-active {
        background: #dcfce7;
        color: #166534;
    }

    .status-maintenance {
        background: #fef3c7;
        color: #92400e;
    }

    .status-inactive {
        background: #fee2e2;
        color: #991b1b;
    }

    .status-retired {
        background: #f3f4f6;
        color: #4b5563;
    }

    .card-actions {
        display: flex;
        gap: 0.375rem;
    }

    .card-body {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.125rem;
    }

    .info-label {
        font-size: 0.6875rem;
        color: var(--text-light);
        text-transform: uppercase;
        letter-spacing: 0.3px;
        font-weight: 500;
    }

    .info-value {
        font-size: 0.9375rem;
        color: var(--text);
        font-weight: 500;
    }

    .card-footer {
        display: flex;
        justify-content: flex-end;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--border);
    }

    /* Specification Details (Expandable) */
    .spec-details {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background: var(--surface-alt);
        border-radius: 8px;
        margin-top: 0.75rem;
    }

    .spec-details.open {
        max-height: 400px;
    }

    .spec-content {
        padding: 1rem;
    }

    .spec-header {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        margin-bottom: 0.75rem;
        color: var(--primary);
    }

    .spec-header svg {
        width: 18px;
        height: 18px;
    }

    .spec-header h3 {
        margin: 0;
        font-size: 0.9375rem;
        font-weight: 600;
    }

    .spec-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
    }

    .toggle-icon {
        transition: transform 0.3s ease;
    }

    .toggle-icon.open {
        transform: rotate(180deg);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 1.5rem;
        background: var(--surface);
        border-radius: 10px;
    }

    .empty-state svg {
        width: 64px;
        height: 64px;
        color: var(--text-light);
        margin-bottom: 0.75rem;
    }

    .empty-state h3 {
        color: var(--text);
        margin-bottom: 0.375rem;
        font-size: 1.125rem;
    }

    .empty-state p {
        color: var(--text-light);
        margin-bottom: 1.25rem;
        font-size: 0.9375rem;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem;
    }

    .modal-overlay.active {
        display: flex;
    }

    /* Toast Notification */
    .toast {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: var(--surface);
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        z-index: 2000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
    }

    .toast.show {
        transform: translateX(0);
    }

    .toast.success {
        border-left: 4px solid #22c55e;
    }

    .toast.error {
        border-left: 4px solid #ef4444;
    }

    .toast-icon {
        width: 24px;
        height: 24px;
    }

    .toast-message {
        color: var(--text);
        font-weight: 500;
    }

    /* Loading Spinner */
    .loading {
        pointer-events: none;
        opacity: 0.6;
    }

    .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .aircraft-container {
            padding: 1rem;
        }

        .aircraft-header {
            flex-direction: column;
            gap: 0.75rem;
            align-items: stretch;
        }

        .card-header {
            flex-direction: column;
            gap: 0.75rem;
            align-items: stretch;
        }

        .card-title {
            justify-content: space-between;
        }

        .card-actions {
            width: 100%;
        }

        .card-actions .btn {
            flex: 1;
        }

        .card-body {
            grid-template-columns: repeat(2, 1fr);
        }

        .spec-grid {
            grid-template-columns: 1fr;
        }

        .toast {
            right: 1rem;
            left: 1rem;
        }
    }
</style>

<div class="aircraft-container">
    <div class="aircraft-header">
        <h1>
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
            Aircraft Fleet
        </h1>
        <button onclick="openCreateModal()" class="btn btn-primary">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Add New Aircraft
        </button>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="aircraft-grid">
            @foreach (var aircraft in Model)
            {
                <div class="aircraft-card">
                    <div class="card-header">
                        <div class="card-title">
                            <h2 class="registration">@aircraft.RegistrationNumber</h2>
                            <span class="status-badge status-@aircraft.Status.ToString().ToLower()">
                                @aircraft.Status
                            </span>
                        </div>
                        <div class="card-actions">
                            <button onclick="openEditModal(@aircraft.Id)" class="btn btn-edit">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                                Edit
                            </button>
                            <button onclick="deleteAircraft(@aircraft.Id)" class="btn btn-delete">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                                Delete
                            </button>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="info-item">
                            <span class="info-label">Model</span>
                            <span class="info-value">@aircraft.Model</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Manufacturer</span>
                            <span class="info-value">@aircraft.Manufacturer</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Serial Number</span>
                            <span class="info-value">@aircraft.SerialNumber</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Year of Manufacture</span>
                            <span class="info-value">@(aircraft.YearOfManufacture?.ToString() ?? "N/A")</span>
                        </div>
                    </div>

                    <div class="card-footer">
                        <button type="button" class="btn btn-details" onclick="toggleSpec('@aircraft.Id')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Specifications
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="toggle-icon" id="icon-@aircraft.Id">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                    </div>

                    <div class="spec-details" id="spec-@aircraft.Id">
                        <div class="spec-content">
                            <div class="spec-header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <h3>Technical Specifications</h3>
                            </div>
                            <div class="spec-grid">
                                <div class="info-item">
                                    <span class="info-label">Based Station</span>
                                    <span class="info-value">@(string.IsNullOrEmpty(aircraft.Specification.BasedStation) ? "N/A" : aircraft.Specification.BasedStation)</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Seating Capacity</span>
                                    <span class="info-value">@aircraft.Specification.SeatingCapacity passengers</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Max Takeoff Weight</span>
                                    <span class="info-value">@aircraft.Specification.MaxTakeoffWeight @aircraft.Specification.WeightUnit</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Max Landing Weight</span>
                                    <span class="info-value">@aircraft.Specification.MaxLandingWeight @aircraft.Specification.WeightUnit</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
            </svg>
            <h3>No Aircraft Found</h3>
            <p>Get started by adding your first aircraft to the fleet.</p>
            <button onclick="openCreateModal()" class="btn btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Add First Aircraft
            </button>
        </div>
    }
</div>

<!-- Modal Container -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
    <div id="modalContent"></div>
</div>

<script>
    function toggleSpec(id) {
        const specElement = document.getElementById('spec-' + id);
        const iconElement = document.getElementById('icon-' + id);
        
        if (specElement.classList.contains('open')) {
            specElement.classList.remove('open');
            iconElement.classList.remove('open');
        } else {
            document.querySelectorAll('.spec-details.open').forEach(el => {
                el.classList.remove('open');
            });
            document.querySelectorAll('.toggle-icon.open').forEach(el => {
                el.classList.remove('open');
            });
            
            specElement.classList.add('open');
            iconElement.classList.add('open');
        }
    }

    function openCreateModal() {
        $.get('@Url.Action("GetCreateModal", "Aircrafts")', function(data) {
            $('#modalContent').html(data);
            $('#modalOverlay').addClass('active');
            setTimeout(() => {
                $.validator.unobtrusive.parse('#aircraftForm');
            }, 100);
        });
    }

    function openEditModal(id) {
        $.get('@Url.Action("GetEditModal", "Aircrafts")/' + id, function(data) {
            $('#modalContent').html(data);
            $('#modalOverlay').addClass('active');
            setTimeout(() => {
                $.validator.unobtrusive.parse('#aircraftForm');
            }, 100);
        }).fail(function(xhr) {
            const response = xhr.responseJSON;
            showToast(response?.message || 'Failed to load aircraft details.', 'error');
        });
    }

    function closeModal() {
        $('#modalOverlay').removeClass('active');
        setTimeout(() => {
            $('#modalContent').html('');
        }, 300);
    }

    function closeModalOnOverlay(event) {
        if (event.target.id === 'modalOverlay') {
            closeModal();
        }
    }

    function deleteAircraft(id) {
        if (confirm('Are you sure you want to delete this aircraft?')) {
            const form = $('<form>', {
                method: 'POST',
                action: '@Url.Action("Delete", "Aircrafts")/' + id
            });
            
            form.append($('@Html.AntiForgeryToken()'));
            
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: form.serialize(),
                success: function(response) {
                    if (response.success) {
                        showToast(response.message, 'success');
                        // Refresh page after short delay
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showToast(response.message, 'error');
                    }
                },
                error: function() {
                    showToast('An error occurred while deleting the aircraft.', 'error');
                }
            });
        }
    }

    function submitForm(event) {
        event.preventDefault();
        event.stopPropagation();
        
        const form = $('#aircraftForm');
        
        // Clear previous errors
        clearFormErrors();
        
        // Check if form has validator attached
        const validator = form.validate();
        if (validator && !validator.form()) {
            // Form is invalid, errors will be shown by validator
            return false;
        }

        const submitBtn = $('#submitBtn');
        const originalHtml = submitBtn.html();
        submitBtn.prop('disabled', true).addClass('loading').html('<div class="spinner"></div> Saving...');

        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    showToast(response.message, 'success');
                    closeModal();
                    
                    // Refresh page after short delay to sync with database
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    // Display validation errors
                    if (response.errors) {
                        displayFormErrors(response.errors);
                    }
                    showToast(response.message, 'error');
                    submitBtn.prop('disabled', false).removeClass('loading').html(originalHtml);
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showToast(response?.message || 'An error occurred. Please try again.', 'error');
                submitBtn.prop('disabled', false).removeClass('loading').html(originalHtml);
            }
        });

        return false;
    }

    function clearFormErrors() {
        $('.form-input').removeClass('error');
        $('.validation-error').removeClass('show').text('');
    }

    function displayFormErrors(errors) {
        for (const [fieldName, messages] of Object.entries(errors)) {
            const input = $(`[name="${fieldName}"]`);
            const errorSpan = input.siblings('.validation-error');
            
            if (input.length && errorSpan.length) {
                input.addClass('error');
                errorSpan.addClass('show').text(messages[0]);
            }
        }
        
        // Scroll to first error
        const firstError = $('.form-input.error').first();
        if (firstError.length) {
            firstError[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstError.focus();
        }
    }

    function showToast(message, type) {
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
            existingToast.remove();
        }

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icon = type === 'success' 
            ? '<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="#22c55e"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
            : '<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="#ef4444"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
        
        toast.innerHTML = `
            ${icon}
            <span class="toast-message">${escapeHtml(message)}</span>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 50);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 6000);
    }

    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.toString().replace(/[&<>"']/g, m => map[m]);
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
        }
    });
</script>